<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '450px' }"
  header="{{ matrixToEdit ? 'Edit Matrix' : 'Create New Matrix' }}"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="onCancel()"
>
  <ng-container *ngIf="loading">
    <div class="flex justify-content-center align-items-center p-4">
      <p-progressSpinner
        [style]="{ width: '50px', height: '50px' }"
        styleClass="custom-spinner"
        strokeWidth="4"
        fill="var(--surface-ground)"
        animationDuration=".5s"
      ></p-progressSpinner>
    </div>
  </ng-container>

  <form
    *ngIf="!loading"
    [formGroup]="matrixForm"
    (ngSubmit)="onSubmit()"
    class="p-fluid"
    @fadeIn
  >
    <div class="grid">
      <div class="col-6">
        <div class="field">
          <label for="maxX" class="font-medium">Width (X)</label>
          <p-inputNumber
            id="maxX"
            formControlName="maxX"
            [showButtons]="true"
            buttonLayout="horizontal"
            spinnerMode="horizontal"
            [min]="1"
            [max]="MAX_DIMENSION"
            decrementButtonClass="p-button-secondary"
            incrementButtonClass="p-button-secondary"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [inputStyleClass]="
              submitted && matrixForm.get('maxX')?.invalid
                ? 'ng-invalid ng-dirty'
                : ''
            "
          ></p-inputNumber>
          <small
            *ngIf="submitted && matrixForm.get('maxX')?.invalid"
            class="p-error"
            >{{ getDimensionErrorMessage("maxX") }}</small
          >
        </div>
      </div>

      <div class="col-6">
        <div class="field">
          <label for="maxY" class="font-medium">Height (Y)</label>
          <p-inputNumber
            id="maxY"
            formControlName="maxY"
            [showButtons]="true"
            buttonLayout="horizontal"
            spinnerMode="horizontal"
            [min]="1"
            [max]="MAX_DIMENSION"
            decrementButtonClass="p-button-secondary"
            incrementButtonClass="p-button-secondary"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [inputStyleClass]="
              submitted && matrixForm.get('maxY')?.invalid
                ? 'ng-invalid ng-dirty'
                : ''
            "
          ></p-inputNumber>
          <small
            *ngIf="submitted && matrixForm.get('maxY')?.invalid"
            class="p-error"
            >{{ getDimensionErrorMessage("maxY") }}</small
          >
        </div>
      </div>
    </div>

    <!-- Warning message when reducing dimensions -->
    <div *ngIf="matrixToEdit && isDimensionReduced()" class="field mt-2">
      <div class="p-message p-message-warning">
        <i class="pi pi-exclamation-triangle p-message-icon"></i>
        <div class="p-message-text">
          <strong>Warning:</strong> Reducing matrix dimensions may cause drones
          to be out of bounds.
        </div>
      </div>
    </div>

    <!-- Preview Mode Selection -->
    <div class="field mt-3">
      <div class="preview-header">
        <label for="previewMode" class="font-medium mb-2">Matrix Preview</label>
        <button
          pButton
          pRipple
          type="button"
          icon="pi {{ previewVisible ? 'pi-eye-slash' : 'pi-eye' }}"
          (click)="togglePreview()"
          class="p-button-rounded p-button-text p-button-sm"
          [pTooltip]="previewVisible ? 'Hide Preview' : 'Show Preview'"
          tooltipPosition="left"
          title="{{ previewVisible ? 'Hide Preview' : 'Show Preview' }}"
        ></button>
      </div>

      <div
        class="preview-mode-selector"
        *ngIf="matrixForm.value.maxX * matrixForm.value.maxY > 25"
      >
        <div class="*ngIf=" matrixForm.value.maxX * matrixForm.value.maxY>
          25">
          <div class="preview-mode-options">
            <label for="displayMode" class="p-radiobutton-label"
              >Display Mode:</label
            >
            <div class="flex align-items-center gap-2">
              <p-radioButton
                formControlName="previewMode"
                value="standard"
                inputId="standard"
                *ngIf="matrixForm.value.maxX * matrixForm.value.maxY <= 100"
              ></p-radioButton>
              <label
                for="standard"
                class="radio-label"
                *ngIf="matrixForm.value.maxX * matrixForm.value.maxY <= 100"
                >Standard</label
              >

              <p-radioButton
                formControlName="previewMode"
                value="optimized"
                inputId="optimized"
              ></p-radioButton>
              <label for="optimized" class="radio-label">Optimized</label>

              <p-radioButton
                formControlName="previewMode"
                value="minimal"
                inputId="minimal"
              ></p-radioButton>
              <label for="minimal" class="radio-label">Minimal</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Matrix Preview Section -->
      <div *ngIf="previewVisible" class="field mt-2">
        <div
          class="matrix-preview border-1 surface-border border-round p-2"
          [ngClass]="{
            'matrix-preview-standard': previewMode === 'standard',
            'matrix-preview-optimized': previewMode === 'optimized',
            'matrix-preview-minimal': previewMode === 'minimal'
          }"
        >
          <!-- Standard DOM-based preview for small matrices -->
          <ng-container *ngIf="!useCanvasPreview">
            <div
              *ngFor="let _ of getPreviewArray(); let i = index"
              class="matrix-cell"
              [ngStyle]="getCellStyle(i)"
              [attr.data-x]="getCellPosition(i).x"
              [attr.data-y]="getCellPosition(i).y"
            ></div>

            <!-- Overlay message for optimized mode -->
            <div *ngIf="previewMode === 'optimized'" class="preview-message">
              <small
                >Showing optimized preview ({{ getPreviewArray().length }} of
                {{ matrixForm.value.maxX * matrixForm.value.maxY }}
                cells)</small
              >
            </div>

            <!-- Overlay message for minimal mode -->
            <div *ngIf="previewMode === 'minimal'" class="preview-message">
              <small>Showing minimal preview (corner cells only)</small>
            </div>
          </ng-container>

          <!-- Canvas-based preview for very large matrices -->
          <ng-container *ngIf="useCanvasPreview">
            <canvas
              #matrixCanvas
              width="400"
              height="300"
              class="matrix-canvas"
              (window:resize)="drawCanvasPreview(matrixCanvas)"
            ></canvas>
            <div class="preview-message">
              <small
                >Showing optimized canvas preview ({{
                  matrixForm.value.maxX
                }}x{{ matrixForm.value.maxY }} matrix)</small
              >
            </div>
          </ng-container>
        </div>
        <small class="text-secondary matrix-dimensions">
          Matrix dimensions: {{ matrixForm.value.maxX }} x
          {{ matrixForm.value.maxY }} ({{
            matrixForm.value.maxX * matrixForm.value.maxY
          }}
          cells total)
        </small>
      </div>

      <p-divider></p-divider>

      <div class="flex justify-content-end gap-2 mt-4">
        <button
          pButton
          pRipple
          type="button"
          label="Cancel"
          class="p-button-outlined p-button-secondary"
          icon="pi pi-times"
          [disabled]="submitting"
          (click)="onCancel()"
          title="Cancel"
        ></button>
        <button
          pButton
          pRipple
          type="submit"
          label="Save"
          icon="pi pi-check"
          [loading]="submitting"
          [disabled]="submitting"
          title="Save"
        ></button>
      </div>

      <p-toast position="top-right"></p-toast>
      <p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
    </div></form
></p-dialog>
