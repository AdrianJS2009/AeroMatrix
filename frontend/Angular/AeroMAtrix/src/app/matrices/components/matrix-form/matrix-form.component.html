<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '450px' }"
  header="{{ matrixToEdit ? 'Edit Matrix' : 'Create New Matrix' }}"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="onCancel()"
>
  <ng-container *ngIf="loading">
    <div class="flex justify-content-center align-items-center p-4">
      <p-progressSpinner
        [style]="{ width: '50px', height: '50px' }"
        styleClass="custom-spinner"
        strokeWidth="4"
        fill="var(--surface-ground)"
        animationDuration=".5s"
      ></p-progressSpinner>
    </div>
  </ng-container>

  <form
    *ngIf="!loading"
    [formGroup]="matrixForm"
    (ngSubmit)="onSubmit()"
    class="p-fluid"
    @fadeIn
  >
    <div class="grid">
      <div class="col-6">
        <div class="field">
          <label for="maxX" class="font-medium">Width (X)</label>
          <p-inputNumber
            id="maxX"
            formControlName="maxX"
            [showButtons]="true"
            buttonLayout="horizontal"
            spinnerMode="horizontal"
            [min]="1"
            [max]="MAX_DIMENSION"
            decrementButtonClass="p-button-secondary"
            incrementButtonClass="p-button-secondary"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [inputStyleClass]="
              submitted && matrixForm.get('maxX')?.invalid
                ? 'ng-invalid ng-dirty'
                : ''
            "
          ></p-inputNumber>
          <small
            *ngIf="submitted && matrixForm.get('maxX')?.invalid"
            class="p-error"
            >{{ getDimensionErrorMessage("maxX") }}</small
          >
        </div>
      </div>

      <div class="col-6">
        <div class="field">
          <label for="maxY" class="font-medium">Height (Y)</label>
          <p-inputNumber
            id="maxY"
            formControlName="maxY"
            [showButtons]="true"
            buttonLayout="horizontal"
            spinnerMode="horizontal"
            [min]="1"
            [max]="MAX_DIMENSION"
            decrementButtonClass="p-button-secondary"
            incrementButtonClass="p-button-secondary"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [inputStyleClass]="
              submitted && matrixForm.get('maxY')?.invalid
                ? 'ng-invalid ng-dirty'
                : ''
            "
          ></p-inputNumber>
          <small
            *ngIf="submitted && matrixForm.get('maxY')?.invalid"
            class="p-error"
            >{{ getDimensionErrorMessage("maxY") }}</small
          >
        </div>
      </div>
    </div>

    <!-- Warning message when reducing dimensions -->
    <div *ngIf="matrixToEdit && isDimensionReduced()" class="field mt-2">
      <div class="p-message p-message-warning">
        <i class="pi pi-exclamation-triangle p-message-icon"></i>
        <div class="p-message-text">
          <strong>Warning:</strong> Reducing matrix dimensions may cause drones
          to be out of bounds.
        </div>
      </div>
    </div>

    <div class="field mt-4">
      <label class="font-medium mb-2 block">Matrix Preview</label>
      <div
        class="matrix-preview border-1 surface-border border-round p-2 flex flex-wrap justify-content-center"
      >
        <div
          *ngFor="let _ of getPreviewArray(); let i = index"
          class="matrix-cell"
          [style.width.%]="100 / matrixForm.value.maxX"
          [attr.data-x]="i % matrixForm.value.maxX"
          [attr.data-y]="Math.floor(i / matrixForm.value.maxX)"
        ></div>
      </div>
      <small class="text-secondary">
        This is a preview of the matrix with dimensions
        {{ matrixForm.value.maxX }} x {{ matrixForm.value.maxY }}
      </small>
    </div>

    <p-divider></p-divider>

    <div class="flex justify-content-end gap-2 mt-4">
      <button
        pButton
        pRipple
        type="button"
        label="Cancel"
        class="p-button-outlined p-button-secondary"
        icon="pi pi-times"
        [disabled]="submitting"
        (click)="onCancel()"
        title="Cancel"
      ></button>
      <button
        pButton
        pRipple
        type="submit"
        label="Save"
        icon="pi pi-check"
        [loading]="submitting"
        [disabled]="submitting"
        title="Save"
      ></button>
    </div>
  </form>
</p-dialog>

<p-toast position="top-right"></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
