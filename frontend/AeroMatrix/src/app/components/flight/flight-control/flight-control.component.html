<div class="flight-control">
  <h2 class="page-title">Flight Control</h2>

  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <div *ngIf="!loading" class="flight-control-content">
    <div class="drone-selection-section">
      <p-card styleClass="drone-selection-card">
        <ng-template pTemplate="title"> Select Drone </ng-template>
        <ng-template pTemplate="content">
          <div class="drone-list">
            <div
              *ngFor="let drone of drones"
              class="drone-item"
              [class.selected]="selectedDrone?.id === drone.id"
            >
              <button
                class="drone-item-content"
                (click)="selectDrone(drone)"
                (keydown.enter)="selectDrone(drone)"
                tabindex="0"
              >
                <div class="drone-icon">
                  <i class="pi pi-send"></i>
                </div>
                <div class="drone-details">
                  <h4>{{ drone.name }}</h4>
                  <p>Position: ({{ drone.x }}, {{ drone.y }})</p>
                  <p>Orientation: {{ drone.orientation }}</p>
                </div>
              </button>
            </div>
            <div *ngIf="drones.length === 0" class="no-drones">
              <p>No drones available</p>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <div class="command-section">
      <p-card styleClass="command-card">
        <ng-template pTemplate="title"> Command Control </ng-template>
        <ng-template pTemplate="subtitle">
          <div *ngIf="selectedDrone" class="selected-drone-info">
            Selected: {{ selectedDrone.name }} ({{ selectedDrone.x }},
            {{ selectedDrone.y }}, {{ selectedDrone.orientation }})
          </div>
          <div *ngIf="!selectedDrone" class="selected-drone-info">
            No drone selected
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <div class="command-controls">
            <div class="command-buttons">
              <div class="command-button-row">
                <button
                  pButton
                  class="p-button-lg"
                  icon="pi pi-arrow-up"
                  (click)="addCommand('F')"
                  [disabled]="executing || !selectedDrone"
                  pTooltip="Move Forward"
                  title="Move Forward"
                ></button>
              </div>
              <div class="command-button-row">
                <button
                  pButton
                  class="p-button-lg"
                  icon="pi pi-arrow-left"
                  (click)="addCommand('L')"
                  [disabled]="executing || !selectedDrone"
                  pTooltip="Turn Left"
                  title="Turn Left"
                ></button>
                <button
                  pButton
                  class="p-button-lg"
                  icon="pi pi-arrow-down"
                  (click)="addCommand('B')"
                  [disabled]="executing || !selectedDrone"
                  pTooltip="Move Backward"
                  title="Move Backward"
                ></button>
                <button
                  pButton
                  class="p-button-lg"
                  icon="pi pi-arrow-right"
                  (click)="addCommand('R')"
                  [disabled]="executing || !selectedDrone"
                  pTooltip="Turn Right"
                  title="Turn Right"
                ></button>
              </div>
            </div>

            <div class="command-input">
              <div class="p-field">
                <label for="commands">Command Sequence</label>
                <div class="p-inputgroup">
                  <input
                    id="commands"
                    type="text"
                    pInputText
                    [(ngModel)]="commands"
                    placeholder="e.g. FFRFFLBB"
                    [disabled]="executing || !selectedDrone"
                  />
                  <button
                    pButton
                    icon="pi pi-times"
                    (click)="clearCommands()"
                    [disabled]="executing || !commands || !selectedDrone"
                    title="Clear Commands"
                  ></button>
                </div>
              </div>

              <div class="command-help">
                <h4>Command Reference</h4>
                <ul>
                  <li><strong>F</strong> - Move forward one step</li>
                  <li><strong>B</strong> - Move backward one step</li>
                  <li><strong>L</strong> - Turn left (90 degrees)</li>
                  <li><strong>R</strong> - Turn right (90 degrees)</li>
                </ul>
              </div>

              <button
                pButton
                label="Execute Commands"
                icon="pi pi-play"
                (click)="executeCommands()"
                [disabled]="executing || !commands || !selectedDrone"
                class="p-button-success execute-button"
                title="Execute Commands"
              ></button>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <div class="visualization-section">
      <p-card styleClass="visualization-card">
        <ng-template pTemplate="title"> Drone Visualization </ng-template>
        <ng-template pTemplate="content">
          <div class="drone-visualization">
            <div *ngIf="selectedDrone" class="position-grid">
              <div
                class="position-cell"
                *ngFor="let y of [].constructor(5); let yIndex = index"
              >
                <div class="position-row">
                  <div
                    class="position-item"
                    *ngFor="let x of [].constructor(5); let xIndex = index"
                    [class.active]="
                      xIndex === selectedDrone.x &&
                      4 - yIndex === selectedDrone.y
                    "
                  >
                    <div
                      *ngIf="
                        xIndex === selectedDrone.x &&
                        4 - yIndex === selectedDrone.y
                      "
                      class="drone-indicator"
                    >
                      <i
                        class="pi"
                        [ngClass]="{
                          'pi-arrow-up': selectedDrone.orientation === 'NORTH',
                          'pi-arrow-right':
                            selectedDrone.orientation === 'EAST',
                          'pi-arrow-down':
                            selectedDrone.orientation === 'SOUTH',
                          'pi-arrow-left': selectedDrone.orientation === 'WEST'
                        }"
                      ></i>
                    </div>
                    <span class="position-coords"
                      >({{ xIndex }}, {{ 4 - yIndex }})</span
                    >
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="!selectedDrone" class="no-drone-selected">
              <p>Select a drone to visualize its position</p>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>
