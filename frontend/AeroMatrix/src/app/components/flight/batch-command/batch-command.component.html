<div class="batch-command">
  <h2 class="page-title">Batch Command Control</h2>

  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <div *ngIf="!loading" class="batch-command-content">
    <div class="command-builder-section">
      <p-card styleClass="command-builder-card">
        <ng-template pTemplate="title"> Command Builder </ng-template>
        <ng-template pTemplate="content">
          <div class="command-builder">
            <div class="p-field">
              <label for="selectedDrones">Select Drones</label>
              <p-dropdown
                id="selectedDrones"
                [options]="drones"
                [(ngModel)]="selectedDrones"
                optionLabel="name"
                [multiple]="true"
                [filter]="true"
                filterBy="name"
                placeholder="Select drones"
                [disabled]="executing"
              >
                <ng-template pTemplate="selectedItem">
                  <div
                    *ngIf="selectedDrones.length > 0"
                    class="selected-drones-chip"
                  >
                    {{ selectedDrones.length }} drone(s) selected
                  </div>
                </ng-template>
              </p-dropdown>
            </div>

            <div class="p-field">
              <label for="sharedCommands">Command Sequence</label>
              <div class="p-inputgroup">
                <input
                  id="sharedCommands"
                  type="text"
                  pInputText
                  [(ngModel)]="sharedCommands"
                  placeholder="e.g. FFRFFLBB"
                  [disabled]="executing"
                />
                <button
                  pButton
                  icon="pi pi-times"
                  (click)="sharedCommands = ''"
                  [disabled]="executing || !sharedCommands"
                  title="Clear Commands"
                ></button>
              </div>
            </div>

            <div class="command-help">
              <h4>Command Reference</h4>
              <ul>
                <li><strong>F</strong> - Move forward one step</li>
                <li><strong>B</strong> - Move backward one step</li>
                <li><strong>L</strong> - Turn left (90 degrees)</li>
                <li><strong>R</strong> - Turn right (90 degrees)</li>
              </ul>
            </div>

            <div class="command-actions">
              <button
                pButton
                label="Execute in Sequence"
                icon="pi pi-play"
                (click)="executeSequence()"
                [disabled]="
                  executing || !sharedCommands || selectedDrones.length === 0
                "
                class="p-button-success"
                title="Execute Commands in Sequence"
              ></button>
              <button
                pButton
                label="Add to Batch"
                icon="pi pi-plus"
                (click)="addToBatch()"
                [disabled]="
                  executing || !sharedCommands || selectedDrones.length === 0
                "
                class="p-button-primary"
                title="Add Commands to Batch"
              ></button>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <div class="batch-list-section">
      <p-card styleClass="batch-list-card">
        <ng-template pTemplate="title"> Batch Commands </ng-template>
        <ng-template pTemplate="content">
          <div class="batch-list">
            <div *ngIf="batchCommands.length === 0" class="empty-batch">
              <p>No commands in batch</p>
            </div>

            <div *ngIf="batchCommands.length > 0" class="batch-items">
              <div
                *ngFor="let command of batchCommands; let i = index"
                class="batch-item"
              >
                <div class="batch-item-content">
                  <div class="batch-item-info">
                    <span class="batch-item-drone">{{
                      getDroneName(command.droneId)
                    }}</span>
                    <span class="batch-item-commands">{{
                      command.commands
                    }}</span>
                  </div>
                  <button
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-danger p-button-sm"
                    (click)="removeBatchItem(i)"
                    [disabled]="executing"
                    title="Remove Item"
                  ></button>
                </div>
              </div>
            </div>

            <div *ngIf="batchCommands.length > 0" class="batch-actions">
              <button
                pButton
                label="Clear Batch"
                icon="pi pi-trash"
                (click)="clearBatch()"
                [disabled]="executing"
                class="p-button-outlined p-button-danger"
                title="Clear All Batch Commands"
              ></button>
              <button
                pButton
                label="Execute Batch"
                icon="pi pi-play"
                (click)="executeBatch()"
                [disabled]="executing"
                class="p-button-success"
                title="Execute All Batch Commands"
              ></button>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <div class="drone-list-section">
      <p-card styleClass="drone-list-card">
        <ng-template pTemplate="title"> Available Drones </ng-template>
        <ng-template pTemplate="content">
          <div class="drone-list">
            <p-table
              [value]="drones"
              styleClass="p-datatable-sm"
              [responsive]="true"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">Position</th>
                  <th scope="col">Orientation</th>
                  <th scope="col">Matrix</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-drone>
                <tr>
                  <td>{{ drone.name }}</td>
                  <td>({{ drone.x }}, {{ drone.y }})</td>
                  <td>{{ drone.orientation }}</td>
                  <td>{{ drone.matrixId }}</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="4" class="text-center">No drones available</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>
